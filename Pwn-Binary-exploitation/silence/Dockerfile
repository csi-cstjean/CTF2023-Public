FROM debian:latest

## Pour que le apt-get soit non-interractif
ENV DEBIAN_FRONTEND noninteractive
ENV DEBCONF_NONINTERACTIVE_SEEN true

# Installation du serveur apache et un paquet d'outils pour obtenir le reverse shell plus tard
RUN apt update && apt install -y sudo net-tools apache2 apache2-utils vsftpd git-all busybox
RUN apt install -y -qq libapache2-mod-php

# Ajout du user e.arcand
RUN groupadd e.arcand
RUN useradd -rm -d /home/e.arcand -s /bin/bash -g e.arcand -u 1000 e.arcand

# Ajout du user pour le FTP
RUN groupadd soumission
RUN useradd -rm -d /var/www/html -s /bin/bash -g soumission -u 1001 soumission

# On copie la config du serveur FTP
COPY config/ftp/vsftpd.conf /etc/vsftpd.conf

# On rend le dossier html writeable par tout le monde
RUN chmod 777 /var/www/html

# On change les password par défaut
RUN  echo 'e.arcand:Yyr8pa8m96UnQvFcSycJkGJA6XD5Bb' | chpasswd
RUN  echo 'root:UUs47jJgdtFTYrcf2mJuDQRf48uhvH' | chpasswd
RUN  echo 'soumission:Password123' | chpasswd

# On prépare le blog
COPY config/apache/envvars-apache2 /etc/apache2/envvars
RUN rm /var/www/html/*
ADD blog.tar /var/www/html

# On prépare la cronjob
COPY config/cron/deplacerPreuve.sh /tmp/deplacerPreuve.sh
RUN chmod 777 /tmp/deplacerPreuve.sh
COPY config/cron/deplacerPreuve /etc/cron.d/deplacerPreuve
RUN chmod 644 /etc/cron.d/deplacerPreuve

# On copie les flags
COPY flags/first-flag.txt /var/www/html/flag.txt
COPY flags/second-flag.txt /home/e.arcand/flag.txt
COPY flags/third-flag.txt /root/flag.txt

EXPOSE 20/tcp 21/tcp 10090-10100/tcp

# On start les services
CMD service apache2 start && service vsftpd start && service cron start && tail -F /var/log/vsftpd.log
# let you attach in bash mode
