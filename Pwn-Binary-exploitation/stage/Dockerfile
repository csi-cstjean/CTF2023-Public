FROM ubuntu:latest

## Pour que le apt-get soit non-interractif
ENV DEBIAN_FRONTEND noninteractive
ENV DEBCONF_NONINTERACTIVE_SEEN true

# Installation du serveur ssh et web
RUN apt update && apt install  openssh-server sudo -y
RUN apt install -y net-tools
RUN apt install -y apache2
RUN apt install -y apache2-utils
RUN apt install -y -qq libapache2-mod-php
RUN apt install -y vim
RUN apt install -y netcat

# Ajout du user prod
RUN groupadd prod
RUN useradd -rm -d /home/prod -s /bin/bash -g prod -u 1000 prod
RUN usermod -aG sudo prod
COPY config/sudoers /etc/sudoers

# On change le password de prod et root pour de quoi de batard (anyway on doit se connecter avec la clef, pas le password)
RUN  echo 'prod:DzZAFtZGMXpjAm1Iti2mOolsrOxEPr' | chpasswd
RUN  echo 'root:d99GtzclaT2g5DJUSgNEIyN3a8QnZ4' | chpasswd

# On configure la clef SSH pour prod
RUN mkdir -p /home/prod/.ssh
RUN chown prod:prod /home/prod/.ssh
COPY ./ssh/id_rsa /home/prod/.ssh
RUN chmod 0600 /home/prod/.ssh/id_rsa
RUN chown prod:prod /home/prod/.ssh/id_rsa
COPY ./ssh/authorized_keys /home/prod/.ssh
RUN chmod 0600 /home/prod/.ssh/authorized_keys
RUN chown prod:prod /home/prod/.ssh/authorized_keys

# On efface le contenu par d√©faut du dossier html
RUN rm /var/www/html/*

# On copie le code source du site web externe dans le serveur apache2
COPY config/apache/envvars-apache2 /etc/apache2/envvars
COPY config/apache/000-default.conf /etc/apache2/sites-available/000-default.conf
RUN mkdir /var/www/html/stage
ADD ./stage /var/www/html/stage

# On copie les flags
COPY ./flags/first-flag.txt /var/www/html/stage/flag.txt
COPY ./flags/second-flag.txt /home/prod/flag.txt
COPY ./flags/third-flag.txt /root/flag.txt

EXPOSE 22
EXPOSE 80

# On start les services
CMD service ssh start && service apache2 start && tail -F /var/log/apache2/error.log