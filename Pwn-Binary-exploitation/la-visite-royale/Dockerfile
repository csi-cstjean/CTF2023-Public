FROM ubuntu:latest

## Pour que le apt-get soit non-interractif
ENV DEBIAN_FRONTEND noninteractive
ENV DEBCONF_NONINTERACTIVE_SEEN true

# Installation du serveur apache et un paquet d'outils pour obtenir le reverse shell plus tard
RUN apt update && apt install -y sudo vsftpd openssh-server

# Ajout du user archive
RUN groupadd archive
RUN useradd -rm -d /home/archive -s /bin/bash -g archive -u 1000 archive

# Ajout du user mgr.chausse
RUN groupadd mgr.chausse
RUN useradd -rm -d /home/mgr.chausse -s /bin/bash -g mgr.chausse -u 1001 mgr.chausse

# On copie la config du serveur FTP
COPY ./config/ftp/vsftpd.conf /etc/vsftpd.conf

# On copy les clefs SSH de mgr.chausse
RUN mkdir /home/mgr.chausse/.ssh
COPY ./config/ssh/id_rsa /home/mgr.chausse/.ssh
RUN chmod 600 /home/mgr.chausse/.ssh/id_rsa
COPY config/ssh/authorized_keys /home/mgr.chausse/.ssh
RUN chmod 644 /home/mgr.chausse/.ssh/authorized_keys

# On change les password par d√©faut
RUN  echo 'mgr.chausse:dh1aXhhfccvmH7ChUJ98d2FHDFc6CG' | chpasswd
RUN  echo 'root:g8GONm0ypYI2k8npGFv9M81bXHf0u1' | chpasswd
RUN  echo 'archive:archive' | chpasswd

# On copie les flags
COPY flags/flag.txt /home/mgr.chausse/flag.txt

# On copie les documents d'archives
ADD ./archives /home/archive

EXPOSE 20/tcp 21/tcp 22/tcp 10090-10100/tcp

# On start les services
CMD service ssh start && service vsftpd start && tail -F /var/log/vsftpd.log